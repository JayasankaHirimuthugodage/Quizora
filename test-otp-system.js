// OTP Password Change Test Script
// Run this in browser console or as a Node.js script

const API_BASE = 'http://localhost:5000/api';

// Test configuration - Update these with your actual values
const testConfig = {
  // Replace with your actual JWT token
  token: 'your_jwt_token_here',
  
  // Replace with your actual current password
  currentPassword: 'your_current_password',
  
  // Test OTP (will be generated by backend)
  otp: '123456',
  
  // New password that meets all requirements
  newPassword: 'NewPassword123@'
};

// Helper function to make API calls
async function apiCall(endpoint, method = 'GET', body = null) {
  const headers = {
    'Content-Type': 'application/json'
  };
  
  if (testConfig.token) {
    headers['Authorization'] = `Bearer ${testConfig.token}`;
  }
  
  const config = {
    method,
    headers,
    ...(body && { body: JSON.stringify(body) })
  };
  
  try {
    console.log(`ğŸš€ Making ${method} request to ${endpoint}`);
    console.log('ğŸ“¤ Request body:', body);
    
    const response = await fetch(`${API_BASE}${endpoint}`, config);
    const data = await response.json();
    
    console.log(`ğŸ“Š Response status: ${response.status}`);
    console.log('ğŸ“¥ Response data:', data);
    
    return { status: response.status, data };
  } catch (error) {
    console.error('âŒ Request failed:', error);
    return { error };
  }
}

// Test functions
async function testRequestOtp() {
  console.log('\nğŸ”‘ Testing OTP Request...');
  return await apiCall('/auth/request-password-change-otp', 'POST', {
    currentPassword: testConfig.currentPassword
  });
}

async function testVerifyOtp() {
  console.log('\nâœ… Testing OTP Verification...');
  return await apiCall('/auth/verify-otp-and-change-password', 'POST', {
    otp: testConfig.otp,
    newPassword: testConfig.newPassword
  });
}

async function testAuth() {
  console.log('\nğŸ” Testing Authentication...');
  return await apiCall('/auth/verify-token');
}

// Password validation test
function validatePassword(password) {
  console.log(`\nğŸ” Validating password: "${password}"`);
  
  const rules = {
    minLength: password.length >= 8,
    hasUppercase: /[A-Z]/.test(password),
    hasLowercase: /[a-z]/.test(password),
    hasNumber: /\d/.test(password),
    hasSpecialChar: /[@$!%*?&]/.test(password)
  };
  
  console.log('ğŸ“‹ Password rules check:', rules);
  
  const isValid = Object.values(rules).every(rule => rule);
  console.log(`${isValid ? 'âœ…' : 'âŒ'} Password is ${isValid ? 'valid' : 'invalid'}`);
  
  return isValid;
}

// OTP validation test
function validateOtp(otp) {
  console.log(`\nğŸ” Validating OTP: "${otp}"`);
  
  const rules = {
    isString: typeof otp === 'string',
    correctLength: otp.length === 6,
    isNumeric: /^\d{6}$/.test(otp)
  };
  
  console.log('ğŸ“‹ OTP rules check:', rules);
  
  const isValid = Object.values(rules).every(rule => rule);
  console.log(`${isValid ? 'âœ…' : 'âŒ'} OTP is ${isValid ? 'valid' : 'invalid'}`);
  
  return isValid;
}

// Main test runner
async function runTests() {
  console.log('ğŸ§ª Starting OTP Password Change Tests...\n');
  
  // Validate inputs first
  console.log('ğŸ” Input Validation:');
  validatePassword(testConfig.newPassword);
  validateOtp(testConfig.otp);
  
  // Test authentication
  const authResult = await testAuth();
  if (authResult.status !== 200) {
    console.error('âŒ Authentication failed. Please check your JWT token.');
    return;
  }
  
  // Test OTP request
  const otpRequestResult = await testRequestOtp();
  if (otpRequestResult.status === 200) {
    console.log('âœ… OTP request successful! Check your email for the OTP.');
  } else {
    console.error('âŒ OTP request failed:', otpRequestResult.data);
    return;
  }
  
  // Wait for user to get OTP from email
  console.log('\nâ³ Please check your email and update testConfig.otp with the received OTP, then run testVerifyOtp()');
}

// Individual test functions you can call manually
window.testOtpSystem = {
  runTests,
  testRequestOtp,
  testVerifyOtp,
  testAuth,
  validatePassword,
  validateOtp,
  
  // Quick setup helper
  setup: (token, currentPassword) => {
    testConfig.token = token;
    testConfig.currentPassword = currentPassword;
    console.log('âœ… Test configuration updated!');
  }
};

// Usage instructions
console.log(`
ğŸ¯ OTP Test System Ready!

ğŸ“ Setup Instructions:
1. Update your JWT token and current password:
   testOtpSystem.setup('your_jwt_token', 'your_current_password')

2. Run full test:
   testOtpSystem.runTests()

ğŸ”§ Individual Tests:
- testOtpSystem.testAuth()           // Test authentication
- testOtpSystem.testRequestOtp()     // Request OTP
- testOtpSystem.testVerifyOtp()      // Verify OTP (after receiving email)

ğŸ” Validation Helpers:
- testOtpSystem.validatePassword('NewPass123@')
- testOtpSystem.validateOtp('123456')

ğŸ’¡ Common Issues:
- 400: Check current password and user role
- 422: Check password/OTP format  
- 429: Wait for rate limit to reset
`);

// Auto-run if this is in Node.js environment
if (typeof window === 'undefined') {
  console.log('ğŸ”„ Running in Node.js mode - please use browser console for interactive testing');
}
